"""This is an integration "unit" test. It uses PloneTestCase, but does not
use doctest syntax.

You will find lots of examples of this type of test in CMFPlone/tests, for
example.
"""

import unittest

from Products.CMFCore.utils import getToolByName
from Products.CMFPlone.utils import _createObjectByType
from Products.PloneTestCase import PloneTestCase
from Products.Five.testbrowser import Browser

from zope.event import notify
from zope.publisher.browser import TestRequest
from plone.validatehook.event import PostValidationEvent

from itcilo.conferences.readunread.extender import READBY_FIELDNAME
from itcilo.conferences.readunread.myutils import get_readby
from itcilo.conferences.readunread.myutils import set_readby
from itcilo.conferences.readunread.myutils import set_unreadby
from itcilo.conferences.readunread.interfaces import IReadByProvider
from itcilo.conferences.readunread.tests import base


def fireViewEvent(obj, userid):
    request = TestRequest()
    user = getToolByName(obj,'acl_users').getUserById(userid)
    event = PostValidationEvent(obj,request,user)
    notify(event)


class TestSetup(base.TestCase):
    """The name of the class should be meaningful. This may be a class that
    tests the installation of a particular product.
    """

    def afterSetUp(self):
        """This method is called before each single test. It can be used to
        set up common state. Setup that is specific to a particular test
        should be done in that test method.
        """
        self.setRoles(['Manager', 'Member'])
        self.portal.invokeFactory('Ploneboard','board')
        self.board = self.portal['board']
        self.forum = self.board.addForum('forum', 'Forum title', 'Forum description')
        self.conversation = self.forum.addConversation('subject', 'conversation body')
        self.readby_fieldname = READBY_FIELDNAME
        self.comment = self.addComment()

    def beforeTearDown(self):
        """This method is called after each single test. It can be used for
        cleanup, if you need it. Note that the test framework will roll back
        the Zope transaction at the end of each test, so tests are generally
        independent of one another. However, if you are modifying external
        resources (say a database) or globals (such as registering a new
        adapter in the Component Architecture during a test), you may want to
        tear things down here.
        """
        self.deleteComment()

    def addComment(self):
        return self.conversation.addComment("comment",
                                            "comment body")

    def deleteComment(self):
        self.conversation._delObject(self.comment.getId())

    def test_install_dependencies(self):
        pass

    js_res_basepath = "++resource++"
    js_files = ['readunread.js', ]

    def test_portal_js(self):
        tool = getToolByName(self.portal,'portal_javascripts')
        for name in self.js_files:
            self.failUnless(self.js_res_basepath + name in tool.getResourceIds(),
                            "%s not found in %s" % (name, tool.getId())
                            )

    css_res_basepath = "++resource++"
    css_files = ['readunread.css', ]

    def test_portal_css(self):
        p_css = getToolByName(self.portal,'portal_css')
        for css_name in self.css_files:
            self.failUnless(self.css_res_basepath + css_name in p_css.getResourceIds(),
                            "%s not found in portal_css" % css_name)


    def test_readby_interface(self):
        self.failUnless(IReadByProvider.providedBy(self.comment))

    def test_readby_field(self):
        # we must not trigger AT events to keep default values
        comment = _createObjectByType('PloneboardComment',
                                      self.conversation,
                                      'conversation')
        schema = comment.Schema()

        # check for field into schema
        self.failUnless(self.readby_fieldname in schema.keys())

        # check field type
        field = schema.getField(self.readby_fieldname)
        self.assertEqual(field.type,'lines')

        # default value should be an empty tuple
        field_value = field.get(comment)
        self.assertEqual(field_value,())

    def test_get_and_set(self):
        username = PloneTestCase.default_user
        # login as simple user
        self.login(username)
        set_readby(self.comment)
        readby = get_readby(self.comment)
        self.failUnless(username in readby)

    def test_readby_catalog_index(self):
        # check index existence
        ct = getToolByName(self.portal, 'portal_catalog')
        self.failUnless('readBy' in ct.indexes())

        # check indexed value
        username = "johndoe"
        set_readby(self.comment,userids=[username])
        self.comment.reindexObject()
        brains = ct(readBy=username)
        self.failUnless(len(brains)==1)

    def test_readby_creator(self):
        username = PloneTestCase.default_user
        # login as simple user
        self.login(username)
        creator = self.comment.Creator()
        readby = get_readby(self.comment)
        self.failUnless(username in readby)

    def test_readby_view_event(self):
        fireViewEvent(self.comment,'user1')
        assert 'user1' in get_readby(self.comment)

        fireViewEvent(self.comment,'user2')
        assert 'user2' in get_readby(self.comment)

        userids = [PloneTestCase.default_user,
                   'user1',
                   'user2',]
        userids.sort()
        readby = list(get_readby(self.comment))
        readby.sort()
        self.assertEquals(userids,readby)

    def test_set_unreadby(self):
        for x in range(1,5):
            fireViewEvent(self.comment,'user%s' % x)

        assert 'user1' in get_readby(self.comment)
        assert 'user2' in get_readby(self.comment)
        set_unreadby(self.comment, ['user1','user2'])
        assert 'user1' not in get_readby(self.comment)
        assert 'user2' not in get_readby(self.comment)

        assert 'user3' in get_readby(self.comment)
        assert 'user4' in get_readby(self.comment)


def test_suite():
    """This sets up a test suite that actually runs the tests in the class
    above
    """
    suite = unittest.TestSuite()
    suite.addTest(unittest.makeSuite(TestSetup))
    return suite